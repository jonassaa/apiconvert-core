name: Publish Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: Optional tag to publish (for example v1.2.3). If empty, latest v* tag is used.
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore and test .NET
        run: |
          dotnet restore
          dotnet build --no-restore
          dotnet test --no-build --verbosity normal

      - name: Check schema versioning policy
        env:
          SCHEMA_CHECK_BASE: ${{ github.event.pull_request.base.sha || github.event.before }}
        run: ./scripts/check-schema-versioning.sh
      - name: Check docs links
        run: ./scripts/check-doc-links.sh

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install npm test dependencies
        working-directory: tests/npm/apiconvert-core-tests
        run: npm ci

      - name: Run npm tests
        working-directory: tests/npm/apiconvert-core-tests
        run: npm test
      - name: CLI smoke test (validate/lint/convert)
        run: |
          node ./src/apiconvert-core/bin/apiconvert.js rules validate ./tests/cases/basic-json/rules.json
          node ./src/apiconvert-core/bin/apiconvert.js rules lint ./tests/cases/basic-json/rules.json
          node ./src/apiconvert-core/bin/apiconvert.js convert \
            --rules ./tests/cases/basic-json/rules.json \
            --input ./tests/cases/basic-json/input.json \
            --output ./tests/parity/cli-smoke-output.json
      - name: Run parity conformance suite
        run: node ./tests/parity/parity-report.mjs --report ./tests/parity/parity-report.json
      - name: Upload parity report
        uses: actions/upload-artifact@v4
        with:
          name: parity-report
          path: tests/parity/parity-report.json

  publish:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve publish tag and version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          requested_tag="${{ github.event.inputs.tag }}"
          selected_tag=""

          if [[ -n "${requested_tag}" ]]; then
            selected_tag="${requested_tag}"
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            selected_tag="${GITHUB_REF_NAME}"
          else
            selected_tag="$(git tag --list 'v*' --sort=-v:refname | head -n 1)"
          fi

          if [[ -z "${selected_tag}" ]]; then
            echo "No publishable tag found."
            exit 1
          fi

          if ! git rev-parse "${selected_tag}" >/dev/null 2>&1; then
            echo "Tag '${selected_tag}' does not exist in this repository."
            exit 1
          fi

          VERSION="${selected_tag#v}"
          if [[ -z "${VERSION}" ]]; then
            echo "Failed to resolve version from tag '${selected_tag}'."
            exit 1
          fi

          if [[ ! "${VERSION}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "Tag '${selected_tag}' is not in v<major>.<minor>.<patch> format."
            exit 1
          fi

          echo "tag=${selected_tag}" >> "${GITHUB_OUTPUT}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Resolved publish tag: ${selected_tag}"
          echo "Resolved package version: ${VERSION}"

      - name: Check schema versioning policy for tag
        env:
          RELEASE_TAG: ${{ steps.version.outputs.tag }}
        run: ./scripts/check-schema-versioning.sh

      - name: Checkout selected tag
        shell: bash
        run: |
          set -euo pipefail
          git checkout "tags/${{ steps.version.outputs.tag }}"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Pack NuGet package
        run: |
          dotnet pack src/Apiconvert.Core/Apiconvert.Core.csproj \
            --configuration Release \
            -p:PackageVersion=${{ steps.version.outputs.version }} \
            -o packages

      - name: NuGet login (OIDC -> temp API key)
        id: nuget_login
        uses: NuGet/login@v1
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Publish NuGet package
        run: dotnet nuget push packages/*.nupkg --api-key ${{ steps.nuget_login.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          registry-url: https://registry.npmjs.org

      - name: Install npm dependencies
        working-directory: src/apiconvert-core
        run: npm ci

      - name: Build npm package
        working-directory: src/apiconvert-core
        run: npm run build --if-present

      - name: Align npm package version to tag
        working-directory: src/apiconvert-core
        run: npm version "${{ steps.version.outputs.version }}" --no-git-tag-version --allow-same-version

      - name: Publish npm package
        working-directory: src/apiconvert-core
        run: npm publish
