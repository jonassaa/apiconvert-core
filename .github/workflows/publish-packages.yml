name: Publish Packages

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore and test .NET
        run: |
          dotnet restore
          dotnet build --no-restore
          dotnet test --no-build --verbosity normal

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install npm test dependencies
        working-directory: tests/npm/apiconvert-core-tests
        run: npm ci

      - name: Run npm tests
        working-directory: tests/npm/apiconvert-core-tests
        run: npm test

  publish:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version from tag
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE}" != "tag" ]]; then
            echo "This workflow publishes packages only from git tags."
            exit 1
          fi
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          if [[ -z "${VERSION}" ]]; then
            echo "Failed to resolve version from tag '${TAG}'."
            exit 1
          fi
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Resolved package version: ${VERSION}"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Pack NuGet package
        run: |
          dotnet pack src/Apiconvert.Core/Apiconvert.Core.csproj \
            --configuration Release \
            -p:PackageVersion=${{ steps.version.outputs.version }} \
            -o packages

      - name: Publish NuGet package
        run: dotnet nuget push packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          registry-url: https://registry.npmjs.org

      - name: Install npm dependencies
        working-directory: src/apiconvert-core
        run: npm ci

      - name: Build npm package
        working-directory: src/apiconvert-core
        run: npm run build --if-present

      - name: Align npm package version to tag
        working-directory: src/apiconvert-core
        run: npm version "${{ steps.version.outputs.version }}" --no-git-tag-version --allow-same-version

      - name: Publish npm package
        working-directory: src/apiconvert-core
        run: npm publish
